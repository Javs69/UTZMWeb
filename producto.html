<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Detalle de producto</title>
  <link rel="stylesheet" href="public/css/styles.css">
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Header (mismo que inicio) -->
  <header class="header">
    <div class="topbar container">
      <a href="/" class="logo" aria-label="Ir al inicio">
        <svg viewBox="0 0 48 48" aria-hidden="true"><circle cx="24" cy="24" r="22"/></svg>
        <span>MiMarket</span>
      </a>

      <form class="search" role="search" aria-label="Buscar productos">
        <input id="searchInput" type="search" placeholder="Buscar productos, marcas y más" aria-label="Buscar"/>
        <button type="submit" aria-label="Buscar">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20l-6-6zM9.5 14C7 14 5 12 5 9.5S7 5 9.5 5 14 7 14 9.5 12 14 9.5 14z"/></svg>
        </button>
        <ul id="searchSuggest" class="search-suggest" role="listbox" aria-label="Sugerencias"></ul>
      </form>

      <nav class="actions" aria-label="Acciones de usuario">
        <a href="/" class="link">Inicio</a>
        <a href="#" class="link">Ayuda</a>

        <div id="cartBtn" class="icon-btn" role="button" aria-label="Carrito" aria-haspopup="menu" aria-expanded="false" tabindex="0">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-1.99.9-1.99 2S15.9 22 17 22s2-.9 2-2-.9-2-2-2zM7.16 14h9.45c.75 0 1.4-.41 1.73-1.03l3.58-6.49A1 1 0 0 0 21 5H6.21l-.94-2H1v2h2l3.6 7.59-1.35 2.44C4.52 15.37 5.48 17 7 17h12v-2H7.42l.74-1z"/></svg>
          <span id="cartBadge" class="badge hidden"></span>
          <div id="cartMenu" class="cart-menu" role="menu" aria-label="Carrito">
            <div class="cart-empty">No hay productos en el carrito</div>
          </div>
        </div>

        <div class="profile" aria-label="Menú de perfil">
          <button id="profileBtn" class="profile-btn" aria-haspopup="menu" aria-expanded="false">
            <img id="avatarImg" src="https://i.pravatar.cc/40?u=guest" alt="Avatar" />
            <span id="profileLabel">Iniciar sesión</span>
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 10l5 5 5-5z"/></svg>
          </button>
          <ul id="profileMenu" class="profile-menu" role="menu" aria-label="Opciones de cuenta">
            <li role="menuitem"><a href="#">Ingresar</a></li>
            <li role="menuitem"><a href="#">Mis compras</a></li>
            <li role="menuitem"><a href="/vender.html">Vender</a></li>
            <li role="menuitem"><a href="#">Favoritos</a></li>
            <li role="menuitem"><a href="#">Salir</a></li>
          </ul>
        </div>
      </nav>
    </div>

    <nav id="catNav" class="categories" aria-label="Categorías">
      <ul class="container">
        <li class="cat"><a href="#">Electrónica</a></li>
        <li class="cat"><a href="#">Hogar</a></li>
        <li class="cat"><a href="#">Moda</a></li>
        <li class="cat"><a href="#">Deportes</a></li>
        <li class="cat"><a href="#">Bebés</a></li>
        <li class="cat"><a href="#">Autos</a></li>
        <li class="cat"><a href="#">Supermercado</a></li>
      </ul>
    </nav>
  </header>

  <main class="container" style="padding:18px 0 34px;">
    <section id="product" class="product"></section>
    <section id="qna" class="qna" aria-labelledby="ttl-qna">
      <h2 id="ttl-qna">Preguntas y respuestas</h2>
      <div id="qList" class="q-list"></div>
      <div id="qAsk" class="q-ask hidden">
        <textarea id="qText" class="form-control" rows="3" placeholder="Escribe tu pregunta"></textarea>
        <div class="form-actions">
          <button id="qSend" class="btn">Preguntar</button>
        </div>
      </div>
      <div id="qLoginHint" class="form-hint">Inicia sesión para hacer preguntas.</div>
    </section>
  </main>

  <!-- Modales de login/register para reusar la UI -->
  <div id="loginModal" class="modal hidden">
    <div class="modal-content">
      <button class="modal-close" data-close>&times;</button>
      <h2>Iniciar sesión</h2>
      <input id="loginEmail" type="email" placeholder="Correo">
      <input id="loginPass" type="password" placeholder="Contraseña">
      <button id="loginSubmit" class="btn">Entrar</button>
      <p>¿No tienes cuenta? <a href="#" id="openRegister">Regístrate</a></p>
    </div>
  </div>
  <div id="registerModal" class="modal hidden">
    <div class="modal-content">
      <button class="modal-close" data-close>&times;</button>
      <h2>Crear cuenta</h2>
      <input id="regName" type="text" placeholder="Tu nombre">
      <input id="regEmail" type="email" placeholder="Correo">
      <input id="regPass" type="password" placeholder="Contraseña">
      <button id="registerSubmit" class="btn">Crear cuenta</button>
      <p>¿Ya tienes cuenta? <a href="#" id="openLogin">Inicia sesión</a></p>
    </div>
  </div>

  <script>
    // Cargar producto por ID y pintar vista
    let PRODUCT = null;
    async function getSession(){
      try{ const r = await fetch('/backend/session.php',{credentials:'include'}); return await r.json(); }catch(_){ return {logged_in:false,user:null}; }
    }

    (async function loadProduct(){
      const el = document.getElementById('product');
      const params = new URLSearchParams(location.search);
      const id = Number(params.get('id')) || 0;
      if (!id) { el.innerHTML = '<p>Producto no encontrado.</p>'; return; }
      try {
        const res = await fetch(`/backend/get_product.php?id=${id}`);
        const p = await res.json();
        if (p.error) { el.innerHTML = `<p>${p.error}</p>`; return; }
        PRODUCT = p;
        const price = (p.price_cents/100).toLocaleString('es-MX',{style:'currency',currency:'MXN'});
        const mainImg = (p.images && p.images[0]) || `https://picsum.photos/seed/${p.id}/800/600`;
        const thumbs = (p.images||[]).map((url,i)=>`<img data-idx="${i}" src="${url}" alt="${p.name} imagen ${i+1}">`).join('');
        el.innerHTML = `
          <div class="pgrid">
            <div class="gallery">
              <div class="gallery-main"><img id="p-main" src="${mainImg}" alt="${p.name}"></div>
              <div class="gallery-thumbs" id="p-thumbs">${thumbs}</div>
            </div>
            <div class="pinfo">
              <h1 class="ptitle">${p.name}</h1>
              <div class="pprice">${price}</div>
              <div class="pstock">${p.stock > 0 ? 'En stock' : 'Sin stock'}</div>
              <div class="pseller">Vendido por <strong>${p.seller_name || p.seller_email || 'Vendedor'}</strong></div>
              <div class="pdesc">${(p.description||'').replace(/\n/g,'<br>')}</div>
              <div style="margin-top:10px;">
                <button class="btn btn-add" data-add-to-cart data-product-id="${p.id}" data-title="${p.name}" data-price="${p.price_cents}" data-seller-id="${p.seller_id}">Agregar al carrito</button>
              </div>
            </div>
          </div>
        `;
        const thumbsEl = document.getElementById('p-thumbs');
        const mainEl = document.getElementById('p-main');
        thumbsEl?.addEventListener('click', (e)=>{
          const img = e.target.closest('img');
          if (!img) return;
          mainEl.src = img.src;
        });
        initQnA();
      } catch (e) {
        el.innerHTML = '<p>Error al cargar producto.</p>';
      }
    })();

    async function loadQnA(){
      const list = document.getElementById('qList');
      list.innerHTML = '<div class="form-hint">Cargando preguntas…</div>';
      try{
        const res = await fetch(`/backend/qna_get.php?product_id=${PRODUCT.id}`);
        const q = await res.json();
        if (Array.isArray(q) && q.length){
          list.innerHTML = q.map(it => `
            <div class="q-item">
              <div class="q-text">${it.text}</div>
              <div class="q-meta">por ${it.user.full_name || 'Usuario'}</div>
              ${it.answer ? `<div class="a-text"><strong>Vendedor:</strong> ${it.answer.text}</div>` : ''}
              <div class="a-form" data-qid="${it.id}"></div>
            </div>
          `).join('');
        } else {
          list.innerHTML = '<div class="form-hint">Aún no hay preguntas.</div>';
        }
      }catch(_){ list.innerHTML = '<div class="form-hint">No se pudieron cargar las preguntas.</div>'; }
    }

    async function initQnA(){
      const sess = await getSession();
      const isLogged = !!sess.logged_in;
      const isSeller = isLogged && sess.user && (sess.user.id === PRODUCT.seller_id);
      const askBox = document.getElementById('qAsk');
      const loginHint = document.getElementById('qLoginHint');
      if (isLogged && !isSeller){ askBox.classList.remove('hidden'); loginHint.classList.add('hidden'); }
      else { askBox.classList.add('hidden'); loginHint.classList.remove('hidden'); }

      await loadQnA();

      // Enviar pregunta
      document.getElementById('qSend')?.addEventListener('click', async ()=>{
        const ta = document.getElementById('qText');
        const text = (ta.value||'').trim();
        if (!text) return alert('Escribe tu pregunta');
        try{
          await fetch('/backend/qna_ask.php', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ product_id: PRODUCT.id, text }) });
          ta.value = '';
          await loadQnA();
        }catch(_){ alert('No se pudo enviar la pregunta'); }
      });

      // Render forms de respuesta si es vendedor
      if (isSeller){
        const list = document.getElementById('qList');
        list.addEventListener('click', async (e)=>{
          const btn = e.target.closest('[data-action="answer"]');
          if (!btn) return;
          const wrap = btn.closest('.a-form');
          const qid = Number(wrap?.dataset.qid);
          const input = wrap.querySelector('input');
          const text = (input.value||'').trim();
          if (!text) return;
          try{
            await fetch('/backend/qna_answer.php',{ method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify({ question_id: qid, text }) });
            await loadQnA();
          }catch(_){ alert('No se pudo responder'); }
        });

        // inyectar campos de respuesta en preguntas sin respuesta
        const inject = ()=>{
          document.querySelectorAll('.a-form').forEach((el)=>{
            if (el.previousElementSibling && el.previousElementSibling.classList.contains('a-text')) return; // ya respondida
            if (el.children.length) return;
            el.innerHTML = '<div class="ans-row"><input class="form-control" type="text" placeholder="Responder..."/><button class="btn" data-action="answer">Enviar</button></div>';
          });
        };
        inject();
        const obs = new MutationObserver(inject);
        obs.observe(document.getElementById('qList'), { childList:true, subtree:true });
      }
    }
  </script>
  <script src="public/js/app.js"></script>
</body>
</html>
