
<!DOCTYPE html>
<html lang="es">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Publicar producto</title>
  <link rel="stylesheet" href="public/css/styles.css">
  <link rel="icon" href="data:,">
  <style>
    .toast-container {
      position: fixed;
      top: 24px;
      right: 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 9999;
      width: min(320px, calc(100% - 32px));
    }
    .toast {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      background: #111827;
      color: #f9fafb;
      border-radius: 12px;
      padding: 14px 16px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.25);
      border-left: 4px solid #2563eb;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.25s ease, transform 0.25s ease;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast-icon { display: flex; width: 32px; height: 32px; border-radius: 999px; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.1); font-size: 16px; }
    .toast-icon svg { width: 18px; height: 18px; }
    .toast-content { flex: 1; }
    .toast-title { font-weight: 600; margin-bottom: 2px; font-size: 0.92rem; }
    .toast-message { margin: 0; font-size: 0.88rem; color: #e5e7eb; }
    .toast-close { background: transparent; border: none; color: inherit; font-size: 1.1rem; cursor: pointer; line-height: 1; padding: 0; }
    .toast.toast-success { border-left-color: #10b981; }
    .toast.toast-success .toast-icon { background: rgba(16, 185, 129, 0.15); }
    .toast.toast-error { border-left-color: #f87171; }
    .toast.toast-error .toast-icon { background: rgba(248, 113, 113, 0.15); }
    .toast.toast-warning { border-left-color: #fbbf24; }
    .toast.toast-warning .toast-icon { background: rgba(251, 191, 36, 0.15); }
  </style>
</head>
<body>
  <!-- Header (consistente con la p&aacute;gina principal) -->
  <header class="header">
    <div class="topbar container">
      <a href="/" class="logo" aria-label="Ir al inicio">
        <!-- Logo minimal -->
        <svg viewBox="0 0 48 48" aria-hidden="true"><circle cx="24" cy="24" r="22"/></svg>
        <span>Utzmplace</span>
      </a>

      <!-- Buscador -->
      <form class="search" role="search" aria-label="Buscar productos">
        <input id="searchInput" type="search" placeholder="Buscar productos, marcas y más" aria-label="Buscar"/>
        <button type="submit" aria-label="Buscar">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20l-6-6zM9.5 14C7 14 5 12 5 9.5S7 5 9.5 5 14 7 14 9.5 12 14 9.5 14z"/></svg>
        </button>
        <ul id="searchSuggest" class="search-suggest" role="listbox" aria-label="Sugerencias"></ul>
      </form>

      <!-- Acciones derecha -->
      <nav class="actions" aria-label="Acciones de usuario">
        <div id="cartBtn" class="icon-btn" role="button" aria-label="Carrito" aria-haspopup="menu" aria-expanded="false" tabindex="0">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zm10 0c-1.1 
    0-1.99.9-1.99 2S15.9 22 17 22s2-.9 2-2-.9-2-2-2zM7.16 14h9.45c.75 0 1.4-.41 
    1.73-1.03l3.58-6.49A1 1 0 0 0 21 5H6.21l-.94-2H1v2h2l3.6 
    7.59-1.35 2.44C4.52 15.37 5.48 17 7 17h12v-2H7.42l.74-1z"/>
  </svg>

  <!-- Nuevo badge dinÃƒÂ¡mico -->
  <span id="cartBadge" class="badge hidden"></span>
  <div id="cartMenu" class="cart-menu" role="menu" aria-label="Carrito">
    <div class="cart-empty">No hay productos en el carrito</div>
  </div>
</div>


        <div class="profile" aria-label="MenÃƒÂº de perfil">
          <button id="profileBtn" class="profile-btn" aria-haspopup="menu" aria-expanded="false">
    <img id="avatarImg" src="/public/uploads/blank-profile.png" alt="Avatar" />
    <span id="profileLabel">Iniciar sesi&oacute;n</span>
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 10l5 5 5-5z"/></svg>
  </button>
                              <ul id="profileMenu" class="profile-menu" role="menu" aria-label="Opciones de cuenta">
            <li role="menuitem"><a href="#">Ingresar</a></li>
            <li role="menuitem"><a href="/mis_publicaciones.html">Mis publicaciones</a></li>
            <li role="menuitem"><a href="/cuenta.html">Cuenta</a></li>
            <li role="menuitem"><a href="/vender.html">Vender</a></li>
            <li role="menuitem"><a href="#" data-logout="true">Cerrar sesión</a></li>
          </ul>
        </div>

        <button id="hamburger" class="hamburger" aria-label="Abrir menÃƒÂº" aria-controls="catNav" aria-expanded="false">
          <span></span><span></span><span></span>
        </button>
      </nav>
    </div>

    <!-- Categor&iacute;as -->
    <nav id="catNav" class="categories" aria-label="CategorÃ­as">
  <ul class="container">
    <li class="cat has-mega">
      <button class="cat-btn" aria-haspopup="true" aria-expanded="false">Electr&oacute;nica</button>
      <div class="mega">
        <div>
          <h4>Celulares</h4>
          <a href="#">Smartphones</a>
          <a href="#">Accesorios</a>
          <a href="#">Wearables</a>
        </div>
        <div>
          <h4>Computaci&oacute;n</h4>
          <a href="#">Laptops</a>
          <a href="#">Perif&eacute;ricos</a>
          <a href="#">Componentes</a>
        </div>
        <div>
          <h4>TV y Audio</h4>
          <a href="#">Televisores</a>
          <a href="#">Bocinas</a>
          <a href="#">Streaming</a>
        </div>
      </div>
    </li>
    <li class="cat"><a href="#">Papeler&iacute;a</a></li>
    <li class="cat"><a href="#">Veh&iacute;culos</a></li>
    <li class="cat"><a href="#">Electrodom&eacute;sticos</a></li>
    <li class="cat"><a href="#">Moda</a></li>
    <li class="cat"><a href="#">Juegos y juguetes</a></li>
    <li class="cat"><a href="#">Salud y equipo m&eacute;dico</a></li>
  </ul>
</nav>
  </header>

  <main class="container" style="padding:18px 0 34px;">
    <section class="hero-card" style="padding:0; overflow:visible;">
      <div class="hero-text" style="padding-bottom:0;">
        <h1>Publicar producto</h1>
        <p>Completa los datos para crear tu publicaci&oacute;n.</p>
      </div>
    </section>

    <section class="card" style="padding:20px; margin-top:16px;">
      <form class="form" novalidate>
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label" for="p-name">Nombre del producto</label>
            <input id="p-name" class="form-control" type="text" placeholder="Ej. Aud&iacute;fonos inal&aacute;mbricos" required>
            <div class="form-hint">Un t&iacute;tulo claro ayuda a que te encuentren.</div>
          </div>

          <div class="form-group">
            <label class="form-label" for="p-category">Categor&iacute;a</label>
            <select id="p-category" class="form-control" required>
  <option value="" disabled selected>Selecciona una categor&iacute;a</option>
  <option value="1">Electr&oacute;nica</option>
  <option value="2">Papeler&iacute;a</option>
  <option value="3">Veh&iacute;culos</option>
  <option value="4">Electrodom&eacute;sticos</option>
  <option value="5">Moda</option>
  <option value="juegos">Juegos y juguetes</option>
  <option value="salud">Salud y equipo m&eacute;dico</option>
</select>
          </div>

          <div class="form-group">
            <label class="form-label" for="p-desc">Descripci&oacute;n</label>
            <textarea id="p-desc" class="form-control" placeholder="Detalles del producto, estado, accesorios incluidos&hellip;" rows="8"></textarea>
            <div class="form-hint">Incluye caracter&iacute;sticas clave y condiciones.</div>
          </div>

          <div class="form-row-2">
            <div class="form-group">
              <label class="form-label" for="p-price">Precio (MXN)</label>
              <input id="p-price" class="form-control" type="number" inputmode="decimal" step="0.01" min="0" placeholder="999.00" required>
            </div>
            <div class="form-group">
              <label class="form-label" for="p-stock">Stock</label>
              <input id="p-stock" class="form-control" type="number" step="1" min="0" placeholder="10" required>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="p-images">Im&aacute;genes</label>
            <div id="dropzone" class="uploader" tabindex="0" aria-describedby="img-hint">
              <div class="uploader-cta">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                <div>
                  <div>A&ntilde;adir im&aacute;genes</div>
                  <small class="muted">Arrastra y suelta o haz clic</small>
                </div>
              </div>
            </div>
            <input id="p-images" class="sr-only" type="file" accept="image/*" multiple>
            <div id="previews" class="thumbs"></div>
            <div id="img-hint" class="form-hint">Hasta 6 im&aacute;genes. M&aacute;x. 5MB c/u.</div>
          </div>
        </div>

        <div class="form-actions">
          <button id="publishBtn" class="btn" type="button">Publicar</button>
          <a class="btn" href="/" style="background:#374151">Cancelar</a>
        </div>
      </form>
    </section>
  </main>

  <!-- Modales de autenticaci?n -->
  <div id="loginModal" class="modal hidden">
    <div class="modal-content">
      <button class="modal-close" data-close>&times;</button>
      <h2>Iniciar sesi&oacute;n</h2>
      <input id="loginEmail" type="email" placeholder="Correo">
      <input id="loginPass" type="password" placeholder="Contrase&ntilde;a">
      <div id="loginError" class="modal-feedback hidden" role="alert"></div>
      <button id="loginSubmit" class="btn">Entrar</button>
      <p>&iquest;No tienes cuenta? <a href="#" id="openRegister">Reg&iacute;strate</a></p>
    </div>
  </div>

  <div id="registerModal" class="modal hidden">
    <div class="modal-content">
      <button class="modal-close" data-close>&times;</button>
      <h2>Crear cuenta</h2>
      <input id="regName" type="text" placeholder="Tu nombre">
      <input id="regEmail" type="email" placeholder="Correo">
      <input id="regPass" type="password" placeholder="Contrase&ntilde;a">
      <div id="registerError" class="modal-feedback hidden" role="alert"></div>
      <button id="registerSubmit" class="btn">Crear cuenta</button>
      <p>&iquest;Ya tienes cuenta? <a href="#" id="openLogin">Inicia sesi&oacute;n</a></p>
    </div>
  </div>

  <script>
    // Sistema de notificaciones tipo toast
    (function notificationCenter(){
      const container = document.createElement('div');
      container.className = 'toast-container';
      document.body.appendChild(container);

      const ICONS = {
        success: '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 13l4 4L19 7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
        error: '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 6l12 12M18 6L6 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>',
        warning: '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 9v4m0 4h.01M3 19h18L12 4 3 19z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
        info: '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 8h.01M11 12h1v4h1m-1-12a9 9 0 100 18 9 9 0 000-18z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'
      };
      const TITLES = {
        success: 'Listo',
        error: 'OcurriÃ³ un error',
        warning: 'Atenci?n',
        info: 'Aviso'
      };

      window.showToast = function(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;

        const icon = document.createElement('span');
        icon.className = 'toast-icon';
        icon.innerHTML = ICONS[type] || ICONS.info;

        const content = document.createElement('div');
        content.className = 'toast-content';

        const title = document.createElement('div');
        title.className = 'toast-title';
        title.textContent = TITLES[type] || TITLES.info;

        const copy = document.createElement('p');
        copy.className = 'toast-message';
        copy.textContent = message;

        content.appendChild(title);
        content.appendChild(copy);

        const close = document.createElement('button');
        close.className = 'toast-close';
        close.type = 'button';
        close.setAttribute('aria-label', 'Cerrar notificaci?n');
        close.innerHTML = '&times;';

        const removeToast = () => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 200);
        };

        close.addEventListener('click', removeToast);

        toast.appendChild(icon);
        toast.appendChild(content);
        toast.appendChild(close);

        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('show'));

        setTimeout(removeToast, 4500);
      };
    })();

    // Protecci?n de ruta: requiere sesi?n
    (async function ensureAuth(){
      try {
        const res = await fetch('/backend/session.php', { credentials: 'include' });
        const s = await res.json();
        if (!s.logged_in) {
          location.replace('/?login=1');
        }
      } catch (e) {
        location.replace('/?login=1');
      }
    })();
    // Uploader m?ltiple con previsualizaci?n
    (function imagesUploader(){
      const input = document.getElementById('p-images');
      const drop = document.getElementById('dropzone');
      const previews = document.getElementById('previews');
      const MAX_FILES = 6;
      const MAX_SIZE = 5 * 1024 * 1024; // 5MB
      const selected = [];

      function render() {
        previews.innerHTML = '';
        selected.forEach((item, idx) => {
          const fig = document.createElement('figure');
          fig.className = 'thumb';
          fig.innerHTML = `
            <img src="${item.url}" alt="Imagen ${idx+1}">
            <button class="remove-thumb" aria-label="Quitar imagen" data-idx="${idx}">&times;</button>
          `;
          previews.appendChild(fig);
        });
      }

      function addFiles(files) {
        for (const file of files) {
          if (!file.type.startsWith('image/')) continue;
          if (file.size > MAX_SIZE) { showToast('Una imagen supera los 5MB permitidos.', 'warning'); continue; }
          if (selected.length >= MAX_FILES) { showToast('M?ximo 6 im?genes por publicaci?n.', 'warning'); break; }
          const url = URL.createObjectURL(file);
          selected.push({ file, url });
        }
        render();
      }

      drop?.addEventListener('click', () => input.click());
      drop?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); input.click(); }
      });
      drop?.addEventListener('dragover', (e) => { e.preventDefault(); drop.classList.add('dragover'); });
      drop?.addEventListener('dragleave', () => drop.classList.remove('dragover'));
      drop?.addEventListener('drop', (e) => {
        e.preventDefault(); drop.classList.remove('dragover');
        addFiles(e.dataTransfer.files || []);
      });
      input?.addEventListener('change', (e) => addFiles(e.target.files || []));

      previews?.addEventListener('click', (e) => {
        const btn = e.target.closest('.remove-thumb');
        if (!btn) return;
        const idx = Number(btn.dataset.idx);
        const item = selected[idx];
        if (item) URL.revokeObjectURL(item.url);
        selected.splice(idx, 1);
        render();
      });
      // Exponer cantidad seleccionada para validaciones
      window.countSelectedImages = () => selected.length;
      // Expone una utilidad para subir las im?genes seleccionadas una vez creado el producto
      window.uploadImagesForProduct = async function(productId){
        for (const item of selected) {
          const fd = new FormData();
          fd.append('imagen', item.file);
          fd.append('product_id', productId);
          try {
            await fetch('/backend/upload_image.php', { method:'POST', body: fd, credentials:'include' });
          } catch(_) {}
        }
      }
    })();

    // Publicar producto real
    (function publishHandler(){
      const btn = document.getElementById('publishBtn');
      if (!btn) return;
      btn.addEventListener('click', async () => {
        const name  = document.getElementById('p-name').value.trim();
        const category = document.getElementById('p-category').value;
        const desc  = document.getElementById('p-desc').value.trim();
        const price = parseFloat(document.getElementById('p-price').value);
        const stock = parseInt(document.getElementById('p-stock').value || '0', 10);
        const imageCount = (typeof window.countSelectedImages === 'function') ? window.countSelectedImages() : 0;
        if (!name) { showToast('Ingresa el nombre del producto.', 'warning'); return; }
        if (!category) { showToast('Selecciona una categoria.', 'warning'); return; }
        if (!desc) { showToast('Ingresa la descripci?n del producto.', 'warning'); return; }
        if (!(price > 0)) { showToast('Ingresa un precio v?lido.', 'warning'); return; }
        if (!Number.isInteger(stock) || stock <= 0) { showToast('Ingresa un stock v?lido.', 'warning'); return; }
        if (imageCount <= 0) { showToast('Agrega al menos una imagen.', 'warning'); return; }

        btn.disabled = true; btn.textContent = 'Publicando...';
        try {
          const res = await fetch('/backend/create_product.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ name, description: desc, price, stock, category })
          });
          const data = await res.json();
          if (data.error) { showToast(data.error, 'error'); return; }
          const productId = data.product_id;
          // Subir im?genes seleccionadas (si hay)
          if (window.uploadImagesForProduct) {
            await window.uploadImagesForProduct(productId);
          }
          showToast('Producto publicado con ?xito.', 'success');
          setTimeout(() => { location.href = '/'; }, 1000);
        } catch (e) {
          showToast('Error al publicar. Intenta de nuevo.', 'error');
        } finally {
          btn.disabled = false; btn.textContent = 'Publicar';
        }
      });
    })();
  </script>
  <script src="public/js/app.js"></script>
</body>
</html>


