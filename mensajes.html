<!DOCTYPE html>



<html lang="es">



<head>



  <meta charset="utf-8"/>



  <meta name="viewport" content="width=device-width,initial-scale=1"/>



  <title>Mensajes con vendedores</title>



  <link rel="stylesheet" href="public/css/styles.css">



  <link rel="icon" href="data:,">



</head>



<body>



  <header class="header">

    <div class="topbar container">

      <a href="/" class="logo" aria-label="Ir al inicio">

        <!-- Logo minimal -->

        <svg viewBox="0 0 48 48" aria-hidden="true">
  <defs><clipPath id="logoClip"><circle cx="24" cy="24" r="22"/></clipPath></defs>
  <image href="/public/uploads/logo.jpeg" x="2" y="2" width="44" height="44" preserveAspectRatio="xMidYMid slice" clip-path="url(#logoClip)"/>
  <circle cx="24" cy="24" r="22" fill="none" stroke="#38bdf8" stroke-width="2"/>
</svg>

        <span>Utzmplace</span>

      </a>



      <!-- Buscador -->

      <form class="search" role="search" aria-label="Buscar productos">

        <input id="searchInput" type="search" placeholder="Buscar productos, marcas y m&aacute;s" aria-label="Buscar"/>

        <button type="submit" aria-label="Buscar">

          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20l-6-6zM9.5 14C7 14 5 12 5 9.5S7 5 9.5 5 14 7 14 9.5 12 14 9.5 14z"/></svg>

        </button>

        <ul id="searchSuggest" class="search-suggest" role="listbox" aria-label="Sugerencias"></ul>

      </form>



      <!-- Acciones derecha -->

      <nav class="actions" aria-label="Acciones de usuario">

        <div id="cartBtn" class="icon-btn" role="button" aria-label="Carrito" aria-haspopup="menu" aria-expanded="false" tabindex="0">

  <svg viewBox="0 0 24 24" aria-hidden="true">

    <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zm10 0c-1.1 

    0-1.99.9-1.99 2S15.9 22 17 22s2-.9 2-2-.9-2-2-2zM7.16 14h9.45c.75 0 1.4-.41 

    1.73-1.03l3.58-6.49A1 1 0 0 0 21 5H6.21l-.94-2H1v2h2l3.6 

    7.59-1.35 2.44C4.52 15.37 5.48 17 7 17h12v-2H7.42l.74-1z"/>

  </svg>



  <!-- Nuevo badge dinÃƒÂ¡mico -->

  <span id="cartBadge" class="badge hidden"></span>

  <div id="cartMenu" class="cart-menu" role="menu" aria-label="Carrito">

    <div class="cart-empty">No hay productos en el carrito</div>

  </div>

</div>





        <div class="profile" aria-label="MenÃƒÂº de perfil">

          <button id="profileBtn" class="profile-btn" aria-haspopup="menu" aria-expanded="false">

    <img id="avatarImg" src="/public/uploads/blank-profile.png" alt="Avatar" />

    <span id="profileLabel">Iniciar sesi&oacute;n</span>

    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 10l5 5 5-5z"/></svg>

  </button>

                              <ul id="profileMenu" class="profile-menu" role="menu" aria-label="Opciones de cuenta">

            <li role="menuitem"><a href="#">Ingresar</a></li>

            <li role="menuitem"><a href="/mis_publicaciones.html">Mis publicaciones</a></li>

            <li role="menuitem"><a href="/cuenta.html">Cuenta</a></li>

            <li role="menuitem"><a href="/vender.html">Vender</a></li>

            <li role="menuitem"><a href="#" data-logout="true">Cerrar sesión</a></li>

          </ul>

        </div>



        <button id="hamburger" class="hamburger" aria-label="Abrir menÃƒÂº" aria-controls="catNav" aria-expanded="false">

          <span></span><span></span><span></span>

        </button>

      </nav>

    </div>



    <!-- Categor&iacute;as -->

    <nav id="catNav" class="categories" aria-label="CategorÃ­as">

  <ul class="container">

    <li class="cat has-mega">

      <button class="cat-btn" aria-haspopup="true" aria-expanded="false">Electr&oacute;nica</button>

      <div class="mega">

        <div>

          <h4>Celulares</h4>

          <a href="#">Smartphones</a>

          <a href="#">Accesorios</a>

          <a href="#">Wearables</a>

        </div>

        <div>

          <h4>Computaci&oacute;n</h4>

          <a href="#">Laptops</a>

          <a href="#">Perif&eacute;ricos</a>

          <a href="#">Componentes</a>

        </div>

        <div>

          <h4>TV y Audio</h4>

          <a href="#">Televisores</a>

          <a href="#">Bocinas</a>

          <a href="#">Streaming</a>

        </div>

      </div>

    </li>

    <li class="cat"><a href="#">Papeler&iacute;a</a></li>

    <li class="cat"><a href="#">Veh&iacute;culos</a></li>

    <li class="cat"><a href="#">Electrodom&eacute;sticos</a></li>

    <li class="cat"><a href="#">Moda</a></li>

    <li class="cat"><a href="#">Juegos y juguetes</a></li>

    <li class="cat"><a href="#">Salud y equipo m&eacute;dico</a></li>

  </ul>

</nav>

  </header>







  <main class="container" style="padding:18px 0 34px;">



    <section class="strip">



      <div class="strip-head">



        <h2>Mensajes</h2>



        <p class="q-meta">Habla con el vendedor o comprador despu&eacute;s de concretar una orden.</p>



      </div>



      <div class="messages-layout">



        <aside class="messages-sidebar">



          <div id="threadsEmpty" class="messages-empty">Cuando realices una orden ver&aacute;s los hilos aqu&iacute;.</div>



          <div id="threadsList" class="messages-threads"></div>



        </aside>



        <section id="chatPanel" class="messages-panel is-disabled" aria-live="polite">



          <div id="chatPlaceholder" class="messages-empty" style="padding:20px; border-bottom:1px solid var(--divider);">



            Selecciona un pedido para ver la conversaci&oacute;n.



          </div>



          <div class="messages-header" id="chatHeader" hidden>



            <h3>Conversaci&oacute;n</h3>



            <p class="q-meta" id="chatSummary"></p>



          </div>



          <div id="chatMessages" class="messages-scroll"></div>



          <form id="chatForm" class="messages-form">



            <div class="messages-field">



              <textarea id="chatInput" placeholder="Escribe tu mensaje..." maxlength="1000" disabled></textarea>



              <div class="messages-tools">



                <label class="messages-upload">



                  <input type="file" id="chatAttachment" accept="image/*" disabled>



                  <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5c-4.42 0-8 3.58-8 8s3.58 8 8 8 8-3.58 8-8h-2a6 6 0 1 1-6-6v2l3-3-3-3v2z"/></svg>



                  Adjuntar imagen



                </label>



                <div id="attachmentPreview" class="attachment-preview" hidden>



                  <img id="attachmentPreviewImg" alt="Vista previa del adjunto"/>



                  <button type="button" id="removeAttachment" aria-label="Quitar adjunto">&times;</button>



                </div>



              </div>



            </div>



            <button id="submitBtn" class="btn" type="submit" disabled>Enviar</button>



          </form>



        </section>



      </div>



    </section>



  </main>







    <footer class="footer">

    <div class="container footer-grid">

      <div>

        <h4>Pagos</h4>

        <a href="/metodos_pago.html" title="Actualmente aceptamos pagos mediante transferencia bancaria y sistemas de pago digitales confiables. Todos los pagos se procesan dentro de la plataforma para mayor seguridad entre comprador y vendedor.">M&eacute;todos de pago</a>

        <a href="/seguridad.html" title="Nos esforzamos por mantener la seguridad de cada transacci&oacute;n. La informaci&oacute;n personal y financiera de los usuarios no se comparte con terceros y se almacena de forma protegida.">Seguridad</a>

        <a href="/facturacion.html" title="Cada compra genera un comprobante interno que puedes consultar desde tu perfil. No emitimos facturas oficiales, pero mantenemos registro de todas las operaciones.">Facturaci&oacute;n</a>

      </div>

      <div>

        <h4>Compras</h4>

        <a href="/envios.html" title="El env&iacute;o o entrega se coordina entre comprador y vendedor; sugiere un punto seguro dentro o cerca de la universidad.">Env&iacute;os</a>

        <a href="/devoluciones.html" title="Las devoluciones dependen del acuerdo entre ambas partes; puedes notificar problemas para recibir ayuda.">Devoluciones</a>

        <a href="/reembolsos.html" title="El pago se retiene hasta confirmar recepci&oacute;n; si no se concreta la entrega, procesamos el reembolso lo antes posible.">Reembolsos</a>

      </div>

      <div>

        <h4>Nosotros</h4>

        <a href="/sobre_nosotros.html" title="Proyecto universitario para un espacio seguro donde la comunidad compra, vende o intercambia productos y servicios.">Sobre nosotros</a>

      </div>

      <div>

        <h4>Ayuda</h4>

        <a href="/centro_de_ayuda.html" title="Respuestas a preguntas comunes sobre compras, ventas, entregas y reembolsos.">Centro de ayuda</a>

        <a href="/contacto.html" title="Soporte personalizado por formulario o correo oficial del proyecto.">Contacto</a>

        <a href="/terminos_privacidad.html" title="Datos usados solo para operar la plataforma; no se comparten con terceros.">T&eacute;rminos y privacidad</a>

      </div>

    </div>

    <div class="copy">&copy; <span id="year"></span> Utzmplace</div>

  </footer>







  <script src="public/js/app.js"></script>



    <script>

    (function(){

      const chatPanel = document.getElementById('chatPanel');

      const threadsList = document.getElementById('threadsList');

      const threadsEmpty = document.getElementById('threadsEmpty');

      const chatHeader = document.getElementById('chatHeader');

      const chatSummary = document.getElementById('chatSummary');

      const chatMessages = document.getElementById('chatMessages');

      const chatPlaceholder = document.getElementById('chatPlaceholder');

      const chatForm = document.getElementById('chatForm');

      const chatInput = document.getElementById('chatInput');

      const submitBtn = document.getElementById('submitBtn');

      const attachmentInput = document.getElementById('chatAttachment');

      const attachmentPreview = document.getElementById('attachmentPreview');

      const attachmentPreviewImg = document.getElementById('attachmentPreviewImg');

      const removeAttachmentBtn = document.getElementById('removeAttachment');

      const MAX_ATTACHMENT_SIZE = 5 * 1024 * 1024; // 5 MB



      let orders = [];

      let activeOrderId = null;

      let activeOrderStatus = null;

      let meId = null;

      let pollTimer = null;

      let lastMessageId = 0;



      const currency = (cents) => {

        if (typeof cents !== 'number') return '';

        return (cents / 100).toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });

      };



      const formatDate = (value) => {

        const date = new Date(value);

        if (Number.isNaN(date.getTime())) return '';

        return date.toLocaleString('es-MX', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });

      };



      function setFormEnabled(enabled) {

        if (!chatInput || !submitBtn) return;

        chatInput.disabled = !enabled;

        submitBtn.disabled = !enabled;

        if (attachmentInput) attachmentInput.disabled = !enabled;

      }



      function clearAttachmentPreview() {

        if (attachmentInput) attachmentInput.value = '';

        if (attachmentPreview) attachmentPreview.hidden = true;

        if (attachmentPreviewImg) attachmentPreviewImg.removeAttribute('src');

      }



      function resetChatPanel(message) {

        activeOrderId = null;

        lastMessageId = 0;

        stopPolling();

        chatMessages.innerHTML = '';

        chatHeader.hidden = true;

        chatSummary.textContent = '';

        chatPlaceholder.textContent = message || 'Selecciona un pedido para ver la conversaci\u00f3n.';

        chatPlaceholder.hidden = false;

        chatPanel?.classList.add('is-disabled');

        setFormEnabled(false);

        clearAttachmentPreview();

        activeOrderStatus = null;

      }



      async function ensureSession() {

        try {

          const res = await fetch('/backend/session.php', { credentials: 'include' });

          const data = await res.json();

          if (!data.logged_in) {

            location.replace('/?login=1');

            return null;

          }

          meId = data.user?.id || null;

          return data;

        } catch (e) {

          location.replace('/?login=1');

          return null;

        }

      }



      async function fetchOrders() {

        try {

          const res = await fetch('/backend/my_orders.php?limit=50', { credentials: 'include' });

          if (!res.ok) throw new Error('fetch');

          const data = await res.json();

          return Array.isArray(data) ? data : (Array.isArray(data.orders) ? data.orders : []);

        } catch (error) {

          console.warn('No se pudieron cargar las Ã³rdenes', error);

          return [];

        }

      }



      function renderThreads() {

        if (!threadsList) return;

        threadsList.innerHTML = '';

        if (!orders.length) {

          threadsEmpty.style.display = 'block';

          return;

        }

        threadsEmpty.style.display = 'none';



        orders.forEach((order) => {

          const button = document.createElement('button');

          button.className = 'thread-item';

          button.type = 'button';

          button.dataset.orderId = order.id;

          if (order.id === activeOrderId) {

            button.classList.add('active');

          }



          const title = document.createElement('p');

          title.className = 'thread-title';

          const isBuyer = order.buyer_id === meId;

          const counterpart = isBuyer ? (order.seller_name || 'Vendedor') : (order.buyer_name || 'Comprador');

          title.textContent = `${counterpart} \u2022 Pedido #${order.id}`;



          const meta = document.createElement('p');

          meta.className = 'thread-meta';

          meta.textContent = `${order.status || 'Sin estado'} \u2022 ${formatDate(order.created_at)}`;



          const last = document.createElement('p');

          last.className = 'thread-last';

          last.textContent = order.last_message || 'Comienza la conversaci\u00f3n';



          if (order.unread_count > 0) {

            const pill = document.createElement('span');

            pill.className = 'unread-pill';

            pill.textContent = order.unread_count;

            title.appendChild(pill);

          }



          button.appendChild(title);

          button.appendChild(meta);

          button.appendChild(last);

          button.addEventListener('click', () => selectOrder(order));

          threadsList.appendChild(button);

        });

      }



      async function loadOrders(selectFirst = false) {

        orders = await fetchOrders();

        renderThreads();

        if (selectFirst && orders.length) {

          selectOrder(orders[0]);

        } else if (activeOrderId) {

          const stillExists = orders.some(o => o.id === activeOrderId);

          if (!stillExists) {

            resetChatPanel('El pedido ya no est\u00e1 disponible.');

          }

        }

      }



      function appendMessage(msg) {

        const wrap = document.createElement('div');

        wrap.className = 'msg-bubble' + (msg.is_mine ? ' mine' : '');

        if (msg.body) {

          const text = document.createElement('p');

          text.className = 'msg-text';

          text.textContent = msg.body;

          wrap.appendChild(text);

        }

        if (msg.attachment_url) {

          const link = document.createElement('a');

          link.href = msg.attachment_url;

          link.target = '_blank';

          link.rel = 'noopener noreferrer';

          link.className = 'msg-attachment';

          link.setAttribute('aria-label', 'Abrir imagen adjunta en una pesta\u00f1a nueva');

          const img = document.createElement('img');

          img.src = msg.attachment_url;

          img.alt = 'Imagen enviada en el chat';

          img.loading = 'lazy';

          link.appendChild(img);

          wrap.appendChild(link);

        }

        const meta = document.createElement('div');

        meta.className = 'msg-meta';

        const author = msg.is_mine ? 'T\u00fa' : (msg.sender_name || 'Usuario');

        meta.textContent = `${author} \u2022 ${formatDate(msg.created_at)}`;

        wrap.appendChild(meta);

        chatMessages.appendChild(wrap);

      }



      async function fetchMessages(opts = { reset: false }) {

        if (!activeOrderId) return;

        const params = new URLSearchParams({ order_id: String(activeOrderId) });

        if (!opts.reset && lastMessageId > 0) {

          params.set('since_id', String(lastMessageId));

        }

        try {

          const res = await fetch(`/backend/order_messages.php?${params.toString()}`, { credentials: 'include' });

          if (!res.ok) throw new Error('fetch');

          const data = await res.json();

          const list = Array.isArray(data.messages) ? data.messages : [];

          if (opts.reset) {

            chatMessages.innerHTML = '';

            lastMessageId = 0;

          }

          list.forEach((msg) => {

            appendMessage(msg);

            lastMessageId = Math.max(lastMessageId, msg.id);

          });

          if (list.length) {

            chatMessages.scrollTop = chatMessages.scrollHeight;

          }

        } catch (e) {

          console.warn('No se pudieron cargar los mensajes', e);

        }

      }



      function startPolling() {

        stopPolling();

        pollTimer = setInterval(() => fetchMessages({ reset: false }), 5000);

      }



      function stopPolling() {

        if (pollTimer) {

          clearInterval(pollTimer);

          pollTimer = null;

        }

      }



      function selectOrder(order) {

        if (!order) return;

        activeOrderId = order.id;

        activeOrderStatus = (order.status || '').toLowerCase();

        lastMessageId = 0;

        chatHeader.hidden = false;

        const isBuyer = order.buyer_id === meId;

        const counterpart = isBuyer ? (order.seller_name || 'Vendedor') : (order.buyer_name || 'Comprador');

        const statusLabel = activeOrderStatus === 'cancelled' ? 'Pedido cancelado por el comprador' : (order.status || '');

        chatSummary.textContent = `${counterpart} \u2022 ${statusLabel} \u2022 ${currency(order.total_cents || 0)}`;

        chatPlaceholder.textContent = activeOrderStatus === 'cancelled'

          ? 'Pedido cancelado por el comprador. Solo puedes ver el historial.'

          : '';

        chatPlaceholder.hidden = activeOrderStatus !== 'cancelled';

        chatPanel?.classList.remove('is-disabled');

        setFormEnabled(activeOrderStatus !== 'cancelled');

        if (chatForm) {

          chatForm.style.display = activeOrderStatus === 'cancelled' ? 'none' : '';

        }

        renderThreads();

        fetchMessages({ reset: true });

        if (activeOrderStatus === 'cancelled') {

          stopPolling();

        } else {

          startPolling();

        }

      }



      attachmentInput?.addEventListener('change', () => {

        if (!attachmentInput.files?.length) {

          clearAttachmentPreview();

          return;

        }

        const file = attachmentInput.files[0];

        if (file.size > MAX_ATTACHMENT_SIZE) {

          alert('La imagen debe pesar menos de 5 MB.');

          attachmentInput.value = '';

          clearAttachmentPreview();

          return;

        }

        if (attachmentPreview && attachmentPreviewImg) {

          const url = URL.createObjectURL(file);

          attachmentPreviewImg.onload = () => URL.revokeObjectURL(url);

          attachmentPreviewImg.src = url;

          attachmentPreview.hidden = false;

        }

      });



      removeAttachmentBtn?.addEventListener('click', () => {

        clearAttachmentPreview();

      });



      chatForm?.addEventListener('submit', async (e) => {

        e.preventDefault();

        if (!activeOrderId || activeOrderStatus === 'cancelled') return;

        const text = chatInput.value.trim();

        const attachmentFile = attachmentInput?.files?.[0] || null;

        if (!text && !attachmentFile) return;

        setFormEnabled(false);

        submitBtn.textContent = 'Enviando';

        try {

          const formData = new FormData();

          formData.append('order_id', activeOrderId);

          if (text) formData.append('body', text);

          if (attachmentFile) formData.append('attachment', attachmentFile);

          const res = await fetch('/backend/order_messages.php', {

            method: 'POST',

            credentials: 'include',

            body: formData

          });

          if (!res.ok) throw new Error('send');

          const data = await res.json();

          if (data?.message) {

            appendMessage(data.message);

            lastMessageId = Math.max(lastMessageId, data.message.id);

            chatMessages.scrollTop = chatMessages.scrollHeight;

            chatInput.value = '';

            clearAttachmentPreview();

            await loadOrders(false);

          }

        } catch (error) {

          alert('No se pudo enviar el mensaje.');

        } finally {

          submitBtn.textContent = 'Enviar';

          setFormEnabled(true);

        }

      });



      window.addEventListener('beforeunload', stopPolling);



      (async function init(){

        const session = await ensureSession();

        if (!session) return;

        await loadOrders(true);

      })();

    })();

  </script>





</body>



</html>
















































